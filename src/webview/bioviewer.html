<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <link rel="icon" href="./favicon.ico" type="image/x-icon">
        <title>BioViewer</title>
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            html, body { width: 100%; height: 100%; overflow: hidden; }
            #app { width: 100%; height: 100%; }
        </style>
        <link rel="stylesheet" type="text/css" href="${cssUri}" />
    </head>
    <body>
        <div id="app"></div>
        <script nonce="${nonce}" type="text/javascript" src="${jsUri}"></script>
        <script nonce="${nonce}" type="text/javascript">
            // Acquire the VS Code API once
            const vscode = acquireVsCodeApi();

            function getParam(name, regex) {
                var r = new RegExp(name + '=' + '(' + regex + ')[&]?', 'i');
                return decodeURIComponent(((window.location.search || '').match(r) || [])[1] || '');
            }

            var debugMode = getParam('debug-mode', '[^&]+').trim() === '1';
            if (debugMode) molstar.setDebugMode(debugMode, debugMode);

            var hideControls = getParam('hide-controls', '[^&]+').trim() === '1';
            var collapseLeftPanel = getParam('collapse-left-panel', '[^&]+').trim() === '1';
            var pdbProvider = getParam('pdb-provider', '[^&]+').trim().toLowerCase();
            var emdbProvider = getParam('emdb-provider', '[^&]+').trim().toLowerCase();
            var mapProvider = getParam('map-provider', '[^&]+').trim().toLowerCase();
            var pixelScale = getParam('pixel-scale', '[^&]+').trim();
            var pickScale = getParam('pick-scale', '[^&]+').trim();
            var pickPadding = getParam('pick-padding', '[^&]+').trim();
            var disableWboit = getParam('disable-wboit', '[^&]+').trim() === '1';
            var preferWebgl1 = getParam('prefer-webgl1', '[^&]+').trim() === '1' || void 0;

            console.log('Initializing BioViewer');

            // Enhanced logging function
            function log(message, type = 'info') {
                const timestamp = new Date().toISOString();
                const logMessage = `[BioViewer Webview][${timestamp}] ${message}`;
                switch(type) {
                    case 'error':
                        console.error(logMessage);
                        break;
                    case 'warn':
                        console.warn(logMessage);
                        break;
                    default:
                        console.log(logMessage);
                }
            }

            // Initialize viewer with better message handling
            try {
                log('Starting viewer initialization');
                molstar.Viewer.create('app', {
                    layoutShowControls: !hideControls,
                    viewportShowExpand: false,
                    collapseLeftPanel: collapseLeftPanel,
                    pdbProvider: pdbProvider || 'pdbe',
                    emdbProvider: emdbProvider || 'pdbe',
                    volumeStreamingServer: (mapProvider || 'pdbe') === 'rcsb'
                        ? 'https://maps.rcsb.org'
                        : 'https://www.ebi.ac.uk/pdbe/densities',
                    pixelScale: parseFloat(pixelScale) || 1,
                    pickScale: parseFloat(pickScale) || 0.25,
                    pickPadding: isNaN(parseFloat(pickPadding)) ? 1 : parseFloat(pickPadding),
                    enableWboit: disableWboit ? true : void 0,
                    preferWebgl1: preferWebgl1,
                }).then(viewer => {
                    window.viewer = viewer;
                    log('Viewer created successfully');
                    signalReady();

                    // Move message handling here after viewer is initialized
                    window.addEventListener('message', event => {
                        try {
                            const message = event.data;
                            log(`Received message: ${JSON.stringify(message)}`);

                            // Validate message
                            if (!message) {
                                throw new Error('No message received');
                            }

                            // Handle the message
                            switch (message.command) {
                                case 'loadStructure':
                                    if (!message.url || !message.format) {
                                        throw new Error('Invalid loadStructure parameters');
                                    }
                                    log('Loading structure...');
                                    vscode.postMessage({ command: 'loading' });
                                    viewer.loadStructureFromUrl(message.url, message.format)
                                        .then(() => {
                                            log('Structure loaded successfully');
                                            vscode.postMessage({ command: 'loaded' });
                                        })
                                        .catch(error => {
                                            log(`Error loading structure: ${error}`, 'error');
                                            vscode.postMessage({ 
                                                command: 'error', 
                                                error: `Error loading structure: ${error}` 
                                            });
                                        });
                                    break;

                                case 'loadVolume':
                                    if (!message.url || !message.format) {
                                        throw new Error('Invalid loadVolume parameters');
                                    }
                                    log('Loading volume...');
                                    vscode.postMessage({ command: 'loading' });
                                    viewer.loadVolumeFromUrl(
                                        {
                                            url: message.url,
                                            format: message.format,
                                            isBinary: message.isBinary
                                        },
                                        [{
                                            type: 'absolute',
                                            value: 0.1,
                                            color: 0x33BB33,
                                            alpha: 0.34,
                                            entryId: message.label
                                        }]
                                    ).then(() => {
                                        log('Volume loaded successfully');
                                        vscode.postMessage({ command: 'loaded' });
                                    }).catch(error => {
                                        log(`Error loading volume: ${error}`, 'error');
                                        vscode.postMessage({ 
                                            command: 'error', 
                                            error: `Error loading volume: ${error}` 
                                        });
                                    });
                                    break;

                                default:
                                    log(`Unknown command: ${message.command}`, 'warn');
                                    break;
                            }
                        } catch (error) {
                            const errorMessage = error instanceof Error ? error.message : String(error);
                            log(`Error handling message: ${errorMessage}`, 'error');
                            vscode.postMessage({ 
                                command: 'error', 
                                error: errorMessage 
                            });
                        }
                    });
                }).catch(error => {
                    log(`Error creating viewer: ${error}`, 'error');
                    vscode.postMessage({ 
                        command: 'error', 
                        error: `Error creating viewer: ${error}` 
                    });
                });
            } catch (error) {
                log(`Error in initialization: ${error}`, 'error');
                vscode.postMessage({ 
                    command: 'error', 
                    error: `Error initializing viewer: ${error}` 
                });
            }

            // Only signal ready once
            let readySent = false;
            function signalReady() {
                if (!readySent) {
                    log('Sending ready signal');
                    vscode.postMessage({ command: 'ready' });
                    readySent = true;
                    log('Ready signal sent');
                }
            }

            // Signal ready on window load as backup
            window.addEventListener('load', () => {
                log('Window load event triggered');
                signalReady();
            });
        </script>
    </body>
</html>